#!/bin/bash -e

CDIR=$(dirname "${BASH_SOURCE}")

set -x

echo $AZURE_LOCATION
echo $AZURE_VM_KEY_NAME
echo $AZURE_VHD_URI
echo $INTERNAL_TLD
echo $CLUSTER_NAME
CIDR_ALLOW_SSH=`$CDIR/myip`
echo $CIDR_VNET
echo $CIDR_PODS
echo $CIDR_SERVICE_CLUSTER
echo $K8S_SERVICE_IP
echo $K8S_DNS_IP
echo $ETCD_IPS
echo $HYPERKUBE_IMAGE
echo $HYPERKUBE_TAG
echo $PKI_IP

set +x

CRED_ARRAY=($(az ad sp create-for-rbac -o tsv | cut -f1,4,5 -d'	'))
SUBSCRIPTION_ID=`az account show  -o tsv| cut -f2 -d'	'`

cat <<EOF > terraform.tfvars
# Generated by scripts/init-variables.sh
azure = {
  subscription_id = "${SUBSCRIPTION_ID}"
  client_id       = "${CRED_ARRAY[0]}"
  client_secret   = "${CRED_ARRAY[1]}"
  tenant_id       = "${CRED_ARRAY[2]}"
}

cidr = {
  allow-ssh = "${CIDR_ALLOW_SSH}"
  pods = "${CIDR_PODS}"
  service-cluster = "${CIDR_SERVICE_CLUSTER}"
  vnet = "${CIDR_VNET}"
}
k8s = {
  hyperkube-image = "${HYPERKUBE_IMAGE}"
  hyperkube-tag = "${HYPERKUBE_TAG}"
}
dns-service-ip = "${K8S_DNS_IP}"
internal-tld = "${INTERNAL_TLD}"
k8s-service-ip = "${K8S_SERVICE_IP}"
name = "${CLUSTER_NAME}"
azure_vhd_uri = "${AZURE_VHD_URI}"
pki-ip = "${PKI_IP}"
etcd-ips = "${ETCD_IPS}"
kube-api-internal-ip = "${KUBE_API_INTERNAL_IP}"
kube-api-public-fqdn = "${KUBE_API_PUBLIC_FQDN}"
EOF

cat terraform.tfvars
