#!/bin/bash

BOOTSTRAP_TOKEN=$(grep bootstrap_token terraform.tfvars | cut -f3 -d " "|tr -d '"')
TOKEN_ID=$(cut -f1 -d '.' <<< $BOOTSTRAP_TOKEN)
TOKEN_CONTENT=$(cut -f2 -d '.' <<< $BOOTSTRAP_TOKEN)

echo $BOOTSTRAP_TOKEN
echo $TOKEN_ID
echo $TOKEN_CONTENT

cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-${TOKEN_ID}
  namespace: kube-system

type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubeadm init'."
  token-id: ${TOKEN_ID}
  token-secret: ${TOKEN_CONTENT}

  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress,system:bootstrappers:kubeadm:default-node-token
EOF
